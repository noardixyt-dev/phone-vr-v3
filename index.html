<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Polished VR Camera HUD</title>
<style>
html,body{height:100%;margin:0;background:#000;color:#fff;overflow:hidden;font-family:system-ui,-apple-system,sans-serif;}
#container{width:100%;height:100vh;position:relative;}
.eyeCanvas{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;}
.menuBox{position:absolute;top:10%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.85);padding:14px;border-radius:14px;display:flex;flex-direction:column;gap:8px;pointer-events:auto;box-shadow:0 0 20px rgba(0,0,0,0.7);}
.menuBtn{background:linear-gradient(135deg,#222,#555);color:#fff;border:none;padding:8px 14px;border-radius:8px;font-size:14px;cursor:pointer;transition:all 0.15s;}
.menuBtn:hover{background:linear-gradient(135deg,#555,#222);}
.menuSlider{width:140px;}
.crosshair{position:absolute;width:14px;height:14px;border-radius:50%;background:white;transform:translate(-50%,-50%);transition:all 0.1s;}
</style>
</head>
<body>
<div id="container">
  <canvas id="left" class="eyeCanvas"></canvas>
  <canvas id="right" class="eyeCanvas"></canvas>
</div>
<video id="video" autoplay playsinline muted style="display:none;"></video>
<div id="menuBox" class="menuBox" style="display:none;"></div>
<div id="crosshair" class="crosshair" style="display:none;"></div>

<script>
const video=document.getElementById('video');
const leftCanvas=document.getElementById('left');
const rightCanvas=document.getElementById('right');
const menuBox=document.getElementById('menuBox');
const crosshair=document.getElementById('crosshair');

let stream=null, rafId=null, zoom=1, eyeGap=20;
let menuVisible=false, deviceYaw=0, devicePitch=0, lastTap=0;
let alwaysShowCrosshair=false;
let draggingSlider=null, dragStartX=0, dragStartValue=0;

// Offscreen rotation canvas
const rotCanvas=document.createElement('canvas');
const rotCtx=rotCanvas.getContext('2d');

// --- Menu UI Elements ---
const startBtn=document.createElement('button'); startBtn.textContent='Start Camera'; startBtn.className='menuBtn';
const flipBtn=document.createElement('button'); flipBtn.textContent='Flip Camera'; flipBtn.className='menuBtn';
const fsBtn=document.createElement('button'); fsBtn.textContent='Fullscreen'; fsBtn.className='menuBtn';
const zoomSlider=document.createElement('input'); zoomSlider.type='range'; zoomSlider.min='1'; zoomSlider.max='2'; zoomSlider.step='0.01'; zoomSlider.value='1'; zoomSlider.className='menuSlider';
const fpsSlider=document.createElement('input'); fpsSlider.type='range'; fpsSlider.min='30'; fpsSlider.max='120'; fpsSlider.step='30'; fpsSlider.value='30'; fpsSlider.className='menuSlider';
const crosshairToggleBtn=document.createElement('button'); crosshairToggleBtn.textContent='Always Show Crosshair'; crosshairToggleBtn.className='menuBtn';

crosshairToggleBtn.onclick=()=>{alwaysShowCrosshair=!alwaysShowCrosshair; crosshairToggleBtn.style.background=alwaysShowCrosshair?'linear-gradient(135deg,#555,#222)':'linear-gradient(135deg,#222,#555)';};

menuBox.appendChild(startBtn);
menuBox.appendChild(flipBtn);
menuBox.appendChild(fsBtn);
menuBox.appendChild(document.createTextNode('Zoom')); menuBox.appendChild(zoomSlider);
menuBox.appendChild(document.createTextNode('FPS')); menuBox.appendChild(fpsSlider);
menuBox.appendChild(crosshairToggleBtn);

// --- Camera Functions ---
async function startCamera(){
  stopCamera();
  try{
    const constraints={audio:false, video:{facingMode:'environment', width:{ideal:1920}, height:{ideal:1080}, frameRate:{ideal:parseInt(fpsSlider.value,10)}}};
    stream=await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject=stream;
    await video.play();
    resizeCanvases();
    drawLoop();
  }catch(e){alert('Camera error: '+e.message);}
}
function stopCamera(){if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;} if(rafId){cancelAnimationFrame(rafId); rafId=null;}}

startBtn.onclick=startCamera;
flipBtn.onclick=async ()=>{
  if(!stream) return;
  const mode=stream.getVideoTracks()[0].getSettings().facingMode==='environment'?'user':'environment';
  const constraints={audio:false, video:{facingMode:mode}};
  stopCamera();
  stream=await navigator.mediaDevices.getUserMedia(constraints);
  video.srcObject=stream;
  await video.play();
};
fsBtn.onclick=()=>{if(!document.fullscreenElement){document.body.requestFullscreen?.();}else{document.exitFullscreen?.();}};
zoomSlider.oninput=e=>{zoom=parseFloat(e.target.value);};
fpsSlider.oninput=e=>{if(stream){const track=stream.getVideoTracks()[0]; if(track.applyConstraints)track.applyConstraints({frameRate:{ideal:parseInt(fpsSlider.value,10)}}); }}

// --- Canvas Resize ---
function resizeCanvases(){
  const dpr=window.devicePixelRatio||1;
  const w=window.innerWidth, h=window.innerHeight;
  const scale=0.85;
  const eyeW=Math.floor(w*scale/2), eyeH=Math.floor(h*scale);
  leftCanvas.width=rightCanvas.width=Math.floor(eyeW*dpr);
  leftCanvas.height=rightCanvas.height=Math.floor(eyeH*dpr);
  leftCanvas.style.width=rightCanvas.style.width=eyeW+'px';
  leftCanvas.style.height=rightCanvas.style.height=eyeH+'px';
  const totalWidth=eyeW*2+eyeGap;
  leftCanvas.style.left=`calc(50% - ${totalWidth/2}px)`;
  rightCanvas.style.left=`calc(50% - ${totalWidth/2}px + ${eyeW+eyeGap}px)`;
  leftCanvas.style.top=rightCanvas.style.top=`calc(50% - ${eyeH/2}px)`;
}
window.addEventListener('resize', resizeCanvases);

// --- Video Rotation ---
function ensureRotated(){ 
  const svw=video.videoWidth, svh=video.videoHeight;
  if(!svw||!svh) return null;
  if(svh<=svw) return video;
  rotCanvas.width=svh; rotCanvas.height=svw;
  rotCtx.save();
  rotCtx.clearRect(0,0,rotCanvas.width,rotCanvas.height);
  rotCtx.translate(rotCanvas.width,0);
  rotCtx.rotate(Math.PI/2);
  rotCtx.drawImage(video,0,0,svw,svh);
  rotCtx.restore();
  return rotCanvas;
}

// --- Orientation Tracking ---
window.addEventListener('deviceorientation', e=>{ deviceYaw=e.alpha||0; devicePitch=e.beta||0; });

// --- Double Tap Menu Toggle ---
window.addEventListener('pointerdown', e=>{
  const now=Date.now();
  if(now-lastTap<300){
    menuVisible=!menuVisible;
    menuBox.style.display=menuVisible?'flex':'none';
    crosshair.style.display=(menuVisible||alwaysShowCrosshair)?'block':'none';
  }
  lastTap=now;
});

// --- Crosshair Hover ---
function updateCrosshair(){
  if(!menuVisible&&!alwaysShowCrosshair){ crosshair.style.display='none'; return; }
  crosshair.style.display='block';
  const rect=menuBox.getBoundingClientRect();
  const cx=window.innerWidth/2, cy=window.innerHeight/2;
  if(cx>=rect.left && cx<=rect.right && cy>=rect.top && cy<=rect.bottom){
    crosshair.style.width='20px'; crosshair.style.height='20px'; crosshair.style.background='white';
  }else{
    crosshair.style.width='14px'; crosshair.style.height='14px';
  }
  crosshair.style.left=cx+'px';
  crosshair.style.top=cy+'px';
}

// --- Check Click ---
window.addEventListener('click', ()=>{
  if(!menuVisible) return;
  const rect=menuBox.getBoundingClientRect();
  const cx=window.innerWidth/2, cy=window.innerHeight/2;
  if(cx>=rect.left && cx<=rect.right && cy>=rect.top && cy<=rect.bottom){
    const btns=menuBox.querySelectorAll('button');
    btns.forEach(btn=>btn.click());
  }
});

// --- Draw Loop ---
function drawLoop(){
  updateCrosshair();
  if(!video.videoWidth){ rafId=requestAnimationFrame(drawLoop); return; }
  const ctxL=leftCanvas.getContext('2d');
  const ctxR=rightCanvas.getContext('2d');
  const src=ensureRotated();
  if(!src){ rafId=requestAnimationFrame(drawLoop); return; }
  [ctxL,ctxR].forEach(ctx=>{
    ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
    ctx.drawImage(src,0,0,src.width,src.height,0,0,ctx.canvas.width,ctx.canvas.height);
  });
  rafId=requestAnimationFrame(drawLoop);
}
</script>
</body>
</html>
