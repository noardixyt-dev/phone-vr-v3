<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VR Camera HUD</title>
<style>
html,body{margin:0;padding:0;width:100%;height:100%;background:#000;overflow:hidden;font-family:system-ui,sans-serif;}
#container{position:relative;width:100%;height:100vh;}
.eyeCanvas{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;}
.crosshair{position:absolute;width:16px;height:16px;border-radius:50%;background:white;transform:translate(-50%,-50%);pointer-events:none;transition:all 0.1s;}
.menuBox{position:absolute;top:20%;left:50%;transform:translateX(-50%);display:flex;flex-direction:row;gap:8px;padding:10px;background:rgba(0,0,0,0.8);border-radius:10px;pointer-events:auto;box-shadow:0 0 20px rgba(0,0,0,0.6);}
.menuBtn{background:linear-gradient(135deg,#222,#555);color:#fff;border:none;padding:6px 10px;border-radius:6px;font-size:13px;cursor:pointer;transition:all 0.15s;}
.menuBtn:hover{background:linear-gradient(135deg,#555,#222);}
.menuSlider{width:100px;}
</style>
</head>
<body>
<div id="container">
  <canvas id="left" class="eyeCanvas"></canvas>
  <canvas id="right" class="eyeCanvas"></canvas>
  <div id="crosshair" class="crosshair"></div>
  <div id="menuBox" class="menuBox" style="display:none;"></div>
</div>
<video id="video" autoplay playsinline muted style="display:none;"></video>

<script>
const video=document.getElementById('video');
const leftCanvas=document.getElementById('left');
const rightCanvas=document.getElementById('right');
const crosshair=document.getElementById('crosshair');
const menuBox=document.getElementById('menuBox');

let stream=null, rafId=null, zoom=1, eyeGap=20;
let menuVisible=false, alwaysShowCrosshair=false, lastTap=0;
let deviceYaw=0, devicePitch=0;

// Offscreen rotation canvas
const rotCanvas=document.createElement('canvas');
const rotCtx=rotCanvas.getContext('2d');

// --- Menu Buttons & Sliders ---
const startBtn=document.createElement('button'); startBtn.textContent='Start Camera'; startBtn.className='menuBtn';
const flipBtn=document.createElement('button'); flipBtn.textContent='Flip Camera'; flipBtn.className='menuBtn';
const fsBtn=document.createElement('button'); fsBtn.textContent='Fullscreen'; fsBtn.className='menuBtn';
const zoomSlider=document.createElement('input'); zoomSlider.type='range'; zoomSlider.min='1'; zoomSlider.max='2'; zoomSlider.step='0.01'; zoomSlider.value='1'; zoomSlider.className='menuSlider';
const fpsSlider=document.createElement('input'); fpsSlider.type='range'; fpsSlider.min='30'; fpsSlider.max='120'; fpsSlider.step='30'; fpsSlider.value='30'; fpsSlider.className='menuSlider';
const crosshairToggleBtn=document.createElement('button'); crosshairToggleBtn.textContent='Always Show Crosshair'; crosshairToggleBtn.className='menuBtn';
crosshairToggleBtn.onclick=()=>{alwaysShowCrosshair=!alwaysShowCrosshair; crosshairToggleBtn.style.background=alwaysShowCrosshair?'linear-gradient(135deg,#555,#222)':'linear-gradient(135deg,#222,#555)';};

menuBox.appendChild(startBtn);
menuBox.appendChild(flipBtn);
menuBox.appendChild(fsBtn);
menuBox.appendChild(zoomSlider);
menuBox.appendChild(fpsSlider);
menuBox.appendChild(crosshairToggleBtn);

// --- Camera Functions ---
async function startCamera(){
  stopCamera();
  try{
    const constraints={audio:false, video:{facingMode:'environment', width:{ideal:1920}, height:{ideal:1080}, frameRate:{ideal:parseInt(fpsSlider.value,10)}}};
    stream=await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject=stream;
    await video.play();
    resizeCanvases();
    drawLoop();
  }catch(e){alert('Camera error: '+e.message);}
}
function stopCamera(){if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;} if(rafId){cancelAnimationFrame(rafId); rafId=null;}}

startBtn.onclick=startCamera;
flipBtn.onclick=async ()=>{
  if(!stream) return;
  const mode=stream.getVideoTracks()[0].getSettings().facingMode==='environment'?'user':'environment';
  const constraints={audio:false, video:{facingMode:mode}};
  stopCamera();
  stream=await navigator.mediaDevices.getUserMedia(constraints);
  video.srcObject=stream;
  await video.play();
};
fsBtn.onclick=()=>{if(!document.fullscreenElement){document.body.requestFullscreen?.();}else{document.exitFullscreen?.();}};
zoomSlider.oninput=e=>{zoom=parseFloat(e.target.value);};
fpsSlider.oninput=e=>{if(stream){const track=stream.getVideoTracks()[0]; if(track.applyConstraints)track.applyConstraints({frameRate:{ideal:parseInt(fpsSlider.value,10)}}); }}

// --- Canvas Resize ---
function resizeCanvases(){
  const dpr=window.devicePixelRatio||1;
  const w=window.innerWidth, h=window.innerHeight;
  const scale=0.85;
  const eyeW=Math.floor(w*scale/2), eyeH=Math.floor(h*scale);
  leftCanvas.width=rightCanvas.width=Math.floor(eyeW*dpr);
  leftCanvas.height=rightCanvas.height=Math.floor(eyeH*dpr);
  leftCanvas.style.width=rightCanvas.style.width=eyeW+'px';
  leftCanvas.style.height=rightCanvas.style.height=eyeH+'px';
  const totalWidth=eyeW*2+eyeGap;
  leftCanvas.style.left=`calc(50% - ${totalWidth/2}px)`;
  rightCanvas.style.left=`calc(50% - ${totalWidth/2}px + ${eyeW+eyeGap}px)`;
  leftCanvas.style.top=rightCanvas.style.top=`calc(50% - ${eyeH/2}px)`;
}
window.addEventListener('resize', resizeCanvases);

// --- Video Rotation ---
function ensureRotated(){ 
  const svw=video.videoWidth, svh=video.videoHeight;
  if(!svw||!svh) return null;
  if(svh<=svw) return video;
  rotCanvas.width=svh; rotCanvas.height=svw;
  rotCtx.save();
  rotCtx.clearRect(0,0,rotCanvas.width,rotCanvas.height);
  rotCtx.translate(rotCanvas.width,0);
  rotCtx.rotate(Math.PI/2);
  rotCtx.drawImage(video,0,0,svw,svh);
  rotCtx.restore();
  return rotCanvas;
}

// --- Orientation Tracking ---
window.addEventListener('deviceorientation', e=>{ deviceYaw=e.alpha||0; devicePitch=e.beta||0; });

// --- Double Tap Menu Toggle ---
window.addEventListener('pointerdown', e=>{
  const now=Date.now();
  if(now-lastTap<300){
    menuVisible=!menuVisible;
    menuBox.style.display=menuVisible?'flex':'none';
    crosshair.style.display=(menuVisible||alwaysShowCrosshair)?'block':'none';
  }
  lastTap=now;
});

// --- Update Crosshair Position ---
function updateCrosshair(){
  if(!menuVisible&&!alwaysShowCrosshair){ crosshair.style.display='none'; return; }
  crosshair.style.display='block';
  crosshair.style.left=`${window.innerWidth/2}px`;
  crosshair.style.top=`${window.innerHeight/2}px`;
}

// --- Draw Loop ---
function drawLoop(){
  updateCrosshair();
  if(!video.videoWidth){ rafId=requestAnimationFrame(drawLoop); return; }
  const ctxL=leftCanvas.getContext('2d');
  const ctxR=rightCanvas.getContext('2d');
  const src=ensureRotated();
  if(!src){ rafId=requestAnimationFrame(drawLoop); return; }
  [ctxL,ctxR].forEach(ctx=>{
    ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
    ctx.drawImage(src,0,0,src.width,src.height,0,0,ctx.canvas.width,ctx.canvas.height);
    // Render menu onto each canvas
    if(menuVisible){
      const rect=menuBox.getBoundingClientRect();
      ctx.fillStyle='rgba(0,0,0,0.8)';
      ctx.fillRect(rect.left,rect.top,rect.width,rect.height);
    }
  });
  rafId=requestAnimationFrame(drawLoop);
}
</script>
</body>
</html>
