<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VR Camera HUD 3D Menu</title>
<style>
html, body { margin:0; padding:0; width:100%; height:100%; background:#000; overflow:hidden; font-family:system-ui,sans-serif; }
#container { position:relative; width:100%; height:100vh; }
.eyeCanvas { position:absolute; top:0; left:0; width:100%; height:100%; background:#000; }
.crosshair { position:absolute; width:16px; height:16px; border-radius:50%; border:2px solid white; box-sizing:border-box; transform:translate(-50%,-50%); pointer-events:none; transition:all 0.1s; }
.menuBox { position:absolute; display:flex; flex-direction:row; gap:8px; padding:10px; background:rgba(0,0,0,0.8); border-radius:10px; pointer-events:auto; box-shadow:0 0 20px rgba(0,0,0,0.6); }
.menuBtn { background:linear-gradient(135deg,#222,#555); color:#fff; border:none; padding:6px 10px; border-radius:6px; font-size:13px; cursor:pointer; transition:all 0.15s; }
.menuBtn:hover { background:linear-gradient(135deg,#555,#222); }
.menuSlider { width:100px; }
.sliderLabel { color:#fff; font-size:12px; margin-bottom:2px; text-align:center; }
</style>
</head>
<body>
<div id="container">
  <canvas id="left" class="eyeCanvas"></canvas>
  <canvas id="right" class="eyeCanvas"></canvas>
  <div id="crossLeft" class="crosshair"></div>
  <div id="crossRight" class="crosshair"></div>
</div>
<video id="video" autoplay playsinline muted style="display:none;"></video>

<script>
const video=document.getElementById('video');
const leftCanvas=document.getElementById('left');
const rightCanvas=document.getElementById('right');
const crossLeft=document.getElementById('crossLeft');
const crossRight=document.getElementById('crossRight');

let stream=null, rafId=null, zoom=1, eyeGap=20;
let menuVisible=false, alwaysShowCross=false, lastTap=0;
let deviceYaw=0, devicePitch=0;
let menu3DPos={x:0, y:0, z:1}; // z is distance forward

// Offscreen rotation canvas
const rotCanvas=document.createElement('canvas');
const rotCtx=rotCanvas.getContext('2d');

// --- Menu Creation ---
const menuLeft=document.createElement('div');
const menuRight=document.createElement('div');
[menuLeft, menuRight].forEach(mb=>{
  mb.className='menuBox'; 
  mb.style.display='none'; 
  document.getElementById('container').appendChild(mb);
});

// Buttons
function createMenu(mb){
  const startBtn=document.createElement('button'); startBtn.textContent='Start Camera'; startBtn.className='menuBtn';
  const flipBtn=document.createElement('button'); flipBtn.textContent='Flip Camera'; flipBtn.className='menuBtn';
  const fsBtn=document.createElement('button'); fsBtn.textContent='Fullscreen'; fsBtn.className='menuBtn';
  const zoomDiv=document.createElement('div');
  const zoomLabel=document.createElement('div'); zoomLabel.className='sliderLabel'; zoomLabel.textContent='Zoom';
  const zoomSlider=document.createElement('input'); zoomSlider.type='range'; zoomSlider.min='1'; zoomSlider.max='2'; zoomSlider.step='0.01'; zoomSlider.value='1'; zoomSlider.className='menuSlider';
  zoomSlider.oninput=e=>{zoom=parseFloat(e.target.value);};
  zoomDiv.appendChild(zoomLabel); zoomDiv.appendChild(zoomSlider);

  const fpsDiv=document.createElement('div');
  const fpsLabel=document.createElement('div'); fpsLabel.className='sliderLabel'; fpsLabel.textContent='FPS';
  const fpsSlider=document.createElement('input'); fpsSlider.type='range'; fpsSlider.min='30'; fpsSlider.max='120'; fpsSlider.step='30'; fpsSlider.value='30'; fpsSlider.className='menuSlider';
  fpsSlider.oninput=e=>{if(stream){const track=stream.getVideoTracks()[0]; if(track.applyConstraints)track.applyConstraints({frameRate:{ideal:parseInt(fpsSlider.value,10)}}); }};
  fpsDiv.appendChild(fpsLabel); fpsDiv.appendChild(fpsSlider);

  const crossBtn=document.createElement('button'); crossBtn.textContent='Always Show Crosshair'; crossBtn.className='menuBtn';
  crossBtn.onclick=()=>{alwaysShowCross=!alwaysShowCross;};

  mb.appendChild(startBtn);
  mb.appendChild(flipBtn);
  mb.appendChild(fsBtn);
  mb.appendChild(zoomDiv);
  mb.appendChild(fpsDiv);
  mb.appendChild(crossBtn);

  startBtn.onclick=startCamera;
  flipBtn.onclick=flipCamera;
  fsBtn.onclick=toggleFullscreen;
}
[menuLeft, menuRight].forEach(createMenu);

// --- Camera ---
async function startCamera(){
  stopCamera();
  try{
    const constraints={audio:false, video:{facingMode:'environment', width:{ideal:1920}, height:{ideal:1080}, frameRate:{ideal:30}}};
    stream=await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject=stream;
    await video.play();
    resizeCanvases();
    drawLoop();
  }catch(e){alert('Camera error: '+e.message);}
}
function stopCamera(){if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;} if(rafId){cancelAnimationFrame(rafId); rafId=null;}}
async function flipCamera(){if(!stream) return; const mode=stream.getVideoTracks()[0].getSettings().facingMode==='environment'?'user':'environment'; stopCamera(); stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:mode}}); video.srcObject=stream; await video.play();}
function toggleFullscreen(){if(!document.fullscreenElement){document.body.requestFullscreen?.();}else{document.exitFullscreen?.();}}

// --- Canvas Resize ---
function resizeCanvases(){
  const dpr=window.devicePixelRatio||1;
  const w=window.innerWidth, h=window.innerHeight;
  const scale=0.85;
  const eyeW=Math.floor(w*scale/2), eyeH=Math.floor(h*scale);
  leftCanvas.width=rightCanvas.width=Math.floor(eyeW*dpr);
  leftCanvas.height=rightCanvas.height=Math.floor(eyeH*dpr);
  leftCanvas.style.width=rightCanvas.style.width=eyeW+'px';
  leftCanvas.style.height=rightCanvas.style.height=eyeH+'px';
  const totalWidth=eyeW*2+eyeGap;
  leftCanvas.style.left=`calc(50% - ${totalWidth/2}px)`;
  rightCanvas.style.left=`calc(50% - ${totalWidth/2}px + ${eyeW+eyeGap}px)`;
  leftCanvas.style.top=rightCanvas.style.top=`calc(50% - ${eyeH/2}px)`;
}
window.addEventListener('resize', resizeCanvases);
resizeCanvases();

// --- Rotation ---
window.addEventListener('deviceorientation', e=>{ deviceYaw=e.alpha||0; devicePitch=e.beta||0; });

// --- Double Tap Menu Spawn ---
window.addEventListener('pointerdown', e=>{
  const now=Date.now();
  if(now-lastTap<300){
    menuVisible=!menuVisible;
    if(menuVisible){
      // spawn menu in front of camera
      menu3DPos={x:0,y:0,z:1}; // forward
    }
    [menuLeft, menuRight].forEach(mb=>mb.style.display=menuVisible?'flex':'none');
    [crossLeft,crossRight].forEach(c=>c.style.display=(menuVisible||alwaysShowCross)?'block':'none');
  }
  lastTap=now;
});

// --- Video Rotation ---
function ensureRotated(){ 
  const svw=video.videoWidth, svh=video.videoHeight;
  if(!svw||!svh) return null;
  if(svh<=svw) return video;
  rotCanvas.width=svh; rotCanvas.height=svw;
  rotCtx.save();
  rotCtx.clearRect(0,0,rotCanvas.width,rotCanvas.height);
  rotCtx.translate(rotCanvas.width,0);
  rotCtx.rotate(Math.PI/2);
  rotCtx.drawImage(video,0,0,svw,svh);
  rotCtx.restore();
  return rotCanvas;
}

// --- Update Crosshairs ---
function updateCrosshairs(){
  const rectL=leftCanvas.getBoundingClientRect();
  const rectR=rightCanvas.getBoundingClientRect();
  crossLeft.style.left=(rectL.left+rectL.width/2)+'px';
  crossLeft.style.top=(rectL.top+rectL.height/2)+'px';
  crossRight.style.left=(rectR.left+rectR.width/2)+'px';
  crossRight.style.top=(rectR.top+rectR.height/2)+'px';
}

// --- Draw Loop ---
function drawLoop(){
  updateCrosshairs();
  if(!video.videoWidth){ rafId=requestAnimationFrame(drawLoop); return; }
  const ctxL=leftCanvas.getContext('2d');
  const ctxR=rightCanvas.getContext('2d');
  const src=ensureRotated();
  if(!src){ rafId=requestAnimationFrame(drawLoop); return; }
  [ctxL,ctxR].forEach(ctx=>{
    ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
    ctx.drawImage(src,0,0,src.width,src.height,0,0,ctx.canvas.width,ctx.canvas.height);
    // Menu 3D transform: simple yaw/pitch mapping
    if(menuVisible){
      const cx=ctx.canvas.width/2 + deviceYaw*ctx.canvas.width/360;
      const cy=ctx.canvas.height/2 - devicePitch*ctx.canvas.height/180;
      const mb=(ctx===ctxL)?menuLeft:menuRight;
      mb.style.left=(cx-mb.offsetWidth/2)+'px';
      mb.style.top=(cy-mb.offsetHeight/2)+'px';
    }
  });
  rafId=requestAnimationFrame(drawLoop);
}
</script>
</body>
</html>
